<!DOCTYPE html>
<html><head><title>C:\Users\micha\OneDrive\Dokumente\GitHub\matRad\matRad_calcPhotonDoseMC.m</title><STYLE TYPE="text/css"><!--TD{font-family: "Courier New", Courier, monospace; font-size: 10pt;}---></STYLE></head><body><p>(Back to <a href="index.html">index</a>)</p><h1>C:\Users\micha\OneDrive\Dokumente\GitHub\matRad\matRad_calcPhotonDoseMC.m</h1><p style="font-family:'Courier New'"><table>
<tr><th>Line</th><th>Code</th></tr>
<tr><td>1</td><td bgcolor="#FFFFFF">function&nbsp;dij&nbsp;=&nbsp;matRad_calcPhotonDoseMC(ct,stf,pln,cst,nCasePerBixel,visBool)</td></tr>
<tr><td>2</td><td bgcolor="#FFFFFF">%&nbsp;matRad&nbsp;ompMC&nbsp;monte&nbsp;carlo&nbsp;photon&nbsp;dose&nbsp;calculation&nbsp;wrapper</td></tr>
<tr><td>3</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>4</td><td bgcolor="#FFFFFF">%&nbsp;call</td></tr>
<tr><td>5</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;dij&nbsp;=&nbsp;matRad_calcPhotonDoseMc(ct,stf,pln,cst,visBool)</td></tr>
<tr><td>6</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>7</td><td bgcolor="#FFFFFF">%&nbsp;input</td></tr>
<tr><td>8</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;ct:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;ct&nbsp;struct</td></tr>
<tr><td>9</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;stf:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;steering&nbsp;information&nbsp;struct</td></tr>
<tr><td>10</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;pln:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;plan&nbsp;meta&nbsp;information&nbsp;struct</td></tr>
<tr><td>11</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;cst:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;cst&nbsp;struct</td></tr>
<tr><td>12</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;visBool:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;binary&nbsp;switch&nbsp;to&nbsp;enable&nbsp;visualization</td></tr>
<tr><td>13</td><td bgcolor="#FFFFFF">%&nbsp;output</td></tr>
<tr><td>14</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;dij:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;dij&nbsp;struct</td></tr>
<tr><td>15</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>16</td><td bgcolor="#FFFFFF">%&nbsp;References</td></tr>
<tr><td>17</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;-</td></tr>
<tr><td>18</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>19</td><td bgcolor="#FFFFFF">%&nbsp;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</td></tr>
<tr><td>20</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>21</td><td bgcolor="#FFFFFF">%&nbsp;Copyright&nbsp;2018&nbsp;the&nbsp;matRad&nbsp;development&nbsp;team.&nbsp;</td></tr>
<tr><td>22</td><td bgcolor="#FFFFFF">%&nbsp;</td></tr>
<tr><td>23</td><td bgcolor="#FFFFFF">%&nbsp;This&nbsp;file&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;matRad&nbsp;project.&nbsp;It&nbsp;is&nbsp;subject&nbsp;to&nbsp;the&nbsp;license&nbsp;</td></tr>
<tr><td>24</td><td bgcolor="#FFFFFF">%&nbsp;terms&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file&nbsp;found&nbsp;in&nbsp;the&nbsp;top-level&nbsp;directory&nbsp;of&nbsp;this&nbsp;</td></tr>
<tr><td>25</td><td bgcolor="#FFFFFF">%&nbsp;distribution&nbsp;and&nbsp;at&nbsp;https://github.com/e0404/matRad/LICENSES.txt.&nbsp;No&nbsp;part&nbsp;</td></tr>
<tr><td>26</td><td bgcolor="#FFFFFF">%&nbsp;of&nbsp;the&nbsp;matRad&nbsp;project,&nbsp;including&nbsp;this&nbsp;file,&nbsp;may&nbsp;be&nbsp;copied,&nbsp;modified,&nbsp;</td></tr>
<tr><td>27</td><td bgcolor="#FFFFFF">%&nbsp;propagated,&nbsp;or&nbsp;distributed&nbsp;except&nbsp;according&nbsp;to&nbsp;the&nbsp;terms&nbsp;contained&nbsp;in&nbsp;the&nbsp;</td></tr>
<tr><td>28</td><td bgcolor="#FFFFFF">%&nbsp;LICENSE&nbsp;file.</td></tr>
<tr><td>29</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>30</td><td bgcolor="#FFFFFF">%&nbsp;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</td></tr>
<tr><td>31</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>32</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>33</td><td bgcolor="#FF0000">matRad_cfg&nbsp;=&nbsp;&nbsp;MatRad_Config.instance();</td></tr>
<tr><td>34</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>35</td><td bgcolor="#FF0000">tic</td></tr>
<tr><td>36</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>37</td><td bgcolor="#FFFFFF">%&nbsp;disable&nbsp;visualiazation&nbsp;by&nbsp;default</td></tr>
<tr><td>38</td><td bgcolor="#FF0000">if&nbsp;nargin&nbsp;&lt;&nbsp;6</td></tr>
<tr><td>39</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;visBool&nbsp;=&nbsp;false;</td></tr>
<tr><td>40</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>41</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>42</td><td bgcolor="#FF0000">if&nbsp;nargin&nbsp;&lt;&nbsp;5</td></tr>
<tr><td>43</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;nCasePerBixel&nbsp;=&nbsp;matRad_cfg.propMC.ompMC_defaultHistories;</td></tr>
<tr><td>44</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;matRad_cfg.dispInfo('Using&nbsp;default&nbsp;number&nbsp;of&nbsp;Histories&nbsp;per&nbsp;Bixel:&nbsp;%d\n',nCasePerBixel);</td></tr>
<tr><td>45</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>46</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>47</td><td bgcolor="#FF0000">fileFolder&nbsp;=&nbsp;fileparts(mfilename('fullpath'));</td></tr>
<tr><td>48</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>49</td><td bgcolor="#FF0000">if&nbsp;~matRad_checkMexFileExists('omc_matrad')&nbsp;%exist('matRad_ompInterface','file')&nbsp;~=&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>50</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;matRad_cfg.dispWarning('Compiled&nbsp;mex&nbsp;interface&nbsp;not&nbsp;found.&nbsp;Trying&nbsp;to&nbsp;compile&nbsp;the&nbsp;ompMC&nbsp;interface&nbsp;on&nbsp;the&nbsp;fly!');&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>51</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>52</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad_compileOmpMCInterface();</td></tr>
<tr><td>53</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;catch&nbsp;MException&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>54</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad_cfg.dispError('Could&nbsp;not&nbsp;find/generate&nbsp;mex&nbsp;interface&nbsp;for&nbsp;MC&nbsp;dose&nbsp;calculation.\nCause&nbsp;of&nbsp;error:\n%s\n&nbsp;Please&nbsp;compile&nbsp;it&nbsp;yourself&nbsp;(preferably&nbsp;with&nbsp;OpenMP&nbsp;support).',MException.message);</td></tr>
<tr><td>55</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>56</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>57</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>58</td><td bgcolor="#FF0000">matRad_calcDoseInit;</td></tr>
<tr><td>59</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>60</td><td bgcolor="#FFFFFF">%&nbsp;gaussian&nbsp;filter&nbsp;to&nbsp;model&nbsp;penumbra&nbsp;from&nbsp;(measured)&nbsp;machine&nbsp;output&nbsp;/&nbsp;see&nbsp;diploma&nbsp;thesis&nbsp;siggel&nbsp;4.1.2</td></tr>
<tr><td>61</td><td bgcolor="#FF0000">if&nbsp;isfield(machine.data,'penumbraFWHMatIso')</td></tr>
<tr><td>62</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;penumbraFWHM&nbsp;=&nbsp;machine.data.penumbraFWHMatIso;</td></tr>
<tr><td>63</td><td bgcolor="#FFFFFF">else</td></tr>
<tr><td>64</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;penumbraFWHM&nbsp;=&nbsp;5;</td></tr>
<tr><td>65</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;matRad_cfg.dispWarning('photon&nbsp;machine&nbsp;file&nbsp;does&nbsp;not&nbsp;contain&nbsp;measured&nbsp;penumbra&nbsp;width&nbsp;in&nbsp;machine.data.penumbraFWHMatIso.&nbsp;Assuming&nbsp;5&nbsp;mm.');</td></tr>
<tr><td>66</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>67</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>68</td><td bgcolor="#FF0000">sourceFWHM&nbsp;=&nbsp;penumbraFWHM&nbsp;*&nbsp;machine.meta.SCD/(machine.meta.SAD&nbsp;-&nbsp;machine.meta.SCD);</td></tr>
<tr><td>69</td><td bgcolor="#FF0000">sigmaGauss&nbsp;=&nbsp;sourceFWHM&nbsp;/&nbsp;sqrt(8*log(2));&nbsp;%&nbsp;[mm]&nbsp;</td></tr>
<tr><td>70</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>71</td><td bgcolor="#FFFFFF">%&nbsp;set&nbsp;up&nbsp;arrays&nbsp;for&nbsp;book&nbsp;keeping</td></tr>
<tr><td>72</td><td bgcolor="#FF0000">dij.bixelNum&nbsp;=&nbsp;NaN*ones(dij.totalNumOfBixels,1);</td></tr>
<tr><td>73</td><td bgcolor="#FF0000">dij.rayNum&nbsp;&nbsp;&nbsp;=&nbsp;NaN*ones(dij.totalNumOfBixels,1);</td></tr>
<tr><td>74</td><td bgcolor="#FF0000">dij.beamNum&nbsp;&nbsp;=&nbsp;NaN*ones(dij.totalNumOfBixels,1);</td></tr>
<tr><td>75</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>76</td><td bgcolor="#FF0000">dij.numHistoriesPerBeamlet&nbsp;=&nbsp;nCasePerBixel;</td></tr>
<tr><td>77</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>78</td><td bgcolor="#FF0000">omcFolder&nbsp;=&nbsp;[matRad_cfg.matRadRoot&nbsp;filesep&nbsp;'ompMC'];</td></tr>
<tr><td>79</td><td bgcolor="#FFFFFF">%omcFolder&nbsp;=&nbsp;[matRad_cfg.matRadRoot&nbsp;filesep&nbsp;'submodules'&nbsp;filesep&nbsp;'ompMC'];</td></tr>
<tr><td>80</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>81</td><td bgcolor="#FFFFFF">%%&nbsp;Setup&nbsp;OmpMC&nbsp;options&nbsp;/&nbsp;parameters</td></tr>
<tr><td>82</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>83</td><td bgcolor="#FFFFFF">%display&nbsp;options</td></tr>
<tr><td>84</td><td bgcolor="#FF0000">ompMCoptions.verbose&nbsp;=&nbsp;matRad_cfg.logLevel&nbsp;-&nbsp;1;</td></tr>
<tr><td>85</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>86</td><td bgcolor="#FFFFFF">%&nbsp;start&nbsp;MC&nbsp;control&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>87</td><td bgcolor="#FF0000">ompMCoptions.nHistories&nbsp;=&nbsp;nCasePerBixel;</td></tr>
<tr><td>88</td><td bgcolor="#FF0000">ompMCoptions.nSplit&nbsp;=&nbsp;20;</td></tr>
<tr><td>89</td><td bgcolor="#FF0000">ompMCoptions.nBatches&nbsp;=&nbsp;10;</td></tr>
<tr><td>90</td><td bgcolor="#FF0000">ompMCoptions.randomSeeds&nbsp;=&nbsp;[97&nbsp;33];</td></tr>
<tr><td>91</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>92</td><td bgcolor="#FFFFFF">%start&nbsp;source&nbsp;definition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>93</td><td bgcolor="#FF0000">ompMCoptions.spectrumFile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;[omcFolder&nbsp;filesep&nbsp;'spectra'&nbsp;filesep&nbsp;'mohan6.spectrum'];</td></tr>
<tr><td>94</td><td bgcolor="#FF0000">ompMCoptions.monoEnergy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0.1;&nbsp;</td></tr>
<tr><td>95</td><td bgcolor="#FF0000">ompMCoptions.charge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0;</td></tr>
<tr><td>96</td><td bgcolor="#FF0000">ompMCoptions.sourceGeometry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'gaussian';</td></tr>
<tr><td>97</td><td bgcolor="#FF0000">ompMCoptions.sourceGaussianWidth&nbsp;=&nbsp;0.1*sigmaGauss;</td></tr>
<tr><td>98</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>99</td><td bgcolor="#FFFFFF">%&nbsp;start&nbsp;MC&nbsp;transport</td></tr>
<tr><td>100</td><td bgcolor="#FF0000">ompMCoptions.dataFolder&nbsp;&nbsp;&nbsp;=&nbsp;[omcFolder&nbsp;filesep&nbsp;'data'&nbsp;filesep];</td></tr>
<tr><td>101</td><td bgcolor="#FF0000">ompMCoptions.pegsFile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;[omcFolder&nbsp;filesep&nbsp;'pegs4'&nbsp;filesep&nbsp;'700icru.pegs4dat'];</td></tr>
<tr><td>102</td><td bgcolor="#FF0000">ompMCoptions.pgs4formFile&nbsp;=&nbsp;[omcFolder&nbsp;filesep&nbsp;'pegs4'&nbsp;filesep&nbsp;'pgs4form.dat'];</td></tr>
<tr><td>103</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>104</td><td bgcolor="#FF0000">ompMCoptions.global_ecut&nbsp;=&nbsp;0.7;</td></tr>
<tr><td>105</td><td bgcolor="#FF0000">ompMCoptions.global_pcut&nbsp;=&nbsp;0.010;&nbsp;</td></tr>
<tr><td>106</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>107</td><td bgcolor="#FFFFFF">%&nbsp;Relative&nbsp;Threshold&nbsp;for&nbsp;dose</td></tr>
<tr><td>108</td><td bgcolor="#FF0000">ompMCoptions.relDoseThreshold&nbsp;=&nbsp;1&nbsp;-&nbsp;matRad_cfg.propDoseCalc.defaultLateralCutOff;</td></tr>
<tr><td>109</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>110</td><td bgcolor="#FFFFFF">%&nbsp;Output&nbsp;folders</td></tr>
<tr><td>111</td><td bgcolor="#FF0000">ompMCoptions.outputFolder&nbsp;=&nbsp;[omcFolder&nbsp;filesep&nbsp;'output'&nbsp;filesep];</td></tr>
<tr><td>112</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>113</td><td bgcolor="#FFFFFF">%&nbsp;Create&nbsp;Material&nbsp;Density&nbsp;Cube</td></tr>
<tr><td>114</td><td bgcolor="#FF0000">material&nbsp;=&nbsp;cell(4,5);</td></tr>
<tr><td>115</td><td bgcolor="#FF0000">material{1,1}&nbsp;=&nbsp;'AIR700ICRU';</td></tr>
<tr><td>116</td><td bgcolor="#FF0000">material{1,2}&nbsp;=&nbsp;-1024;&nbsp;</td></tr>
<tr><td>117</td><td bgcolor="#FF0000">material{1,3}&nbsp;=&nbsp;-974;</td></tr>
<tr><td>118</td><td bgcolor="#FF0000">material{1,4}&nbsp;=&nbsp;0.001;</td></tr>
<tr><td>119</td><td bgcolor="#FF0000">material{1,5}&nbsp;=&nbsp;0.044;</td></tr>
<tr><td>120</td><td bgcolor="#FF0000">material{2,1}&nbsp;=&nbsp;'LUNG700ICRU';</td></tr>
<tr><td>121</td><td bgcolor="#FF0000">material{2,2}&nbsp;=&nbsp;-974;&nbsp;</td></tr>
<tr><td>122</td><td bgcolor="#FF0000">material{2,3}&nbsp;=&nbsp;-724;</td></tr>
<tr><td>123</td><td bgcolor="#FF0000">material{2,4}&nbsp;=&nbsp;0.044;&nbsp;</td></tr>
<tr><td>124</td><td bgcolor="#FF0000">material{2,5}&nbsp;=&nbsp;0.302;</td></tr>
<tr><td>125</td><td bgcolor="#FF0000">material{3,1}&nbsp;=&nbsp;'ICRUTISSUE700ICRU';</td></tr>
<tr><td>126</td><td bgcolor="#FF0000">material{3,2}&nbsp;=&nbsp;-724;&nbsp;</td></tr>
<tr><td>127</td><td bgcolor="#FF0000">material{3,3}&nbsp;=&nbsp;101;</td></tr>
<tr><td>128</td><td bgcolor="#FF0000">material{3,4}&nbsp;=&nbsp;0.302;&nbsp;</td></tr>
<tr><td>129</td><td bgcolor="#FF0000">material{3,5}&nbsp;=&nbsp;1.101;</td></tr>
<tr><td>130</td><td bgcolor="#FF0000">material{4,1}&nbsp;=&nbsp;'ICRPBONE700ICRU';</td></tr>
<tr><td>131</td><td bgcolor="#FF0000">material{4,2}&nbsp;=&nbsp;101;&nbsp;</td></tr>
<tr><td>132</td><td bgcolor="#FF0000">material{4,3}&nbsp;=&nbsp;1976;</td></tr>
<tr><td>133</td><td bgcolor="#FF0000">material{4,4}&nbsp;=&nbsp;1.101;&nbsp;</td></tr>
<tr><td>134</td><td bgcolor="#FF0000">material{4,5}&nbsp;=&nbsp;2.088;</td></tr>
<tr><td>135</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>136</td><td bgcolor="#FFFFFF">%&nbsp;conversion&nbsp;from&nbsp;HU&nbsp;to&nbsp;densities&nbsp;&amp;&nbsp;materials</td></tr>
<tr><td>137</td><td bgcolor="#FF0000">for&nbsp;s&nbsp;=&nbsp;1:dij.numOfScenarios</td></tr>
<tr><td>138</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>139</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;HUcube{s}&nbsp;=&nbsp;&nbsp;matRad_interp3(dij.ctGrid.x,dij.ctGrid.y',dij.ctGrid.z,ct.cubeHU{s},&nbsp;...</td></tr>
<tr><td>140</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dij.doseGrid.x,dij.doseGrid.y',dij.doseGrid.z,'nearest');</td></tr>
<tr><td>141</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>142</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;projecting&nbsp;out&nbsp;of&nbsp;bounds&nbsp;HU&nbsp;values&nbsp;where&nbsp;necessary</td></tr>
<tr><td>143</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;max(HUcube{s}(:))&nbsp;&gt;&nbsp;material{end,3}</td></tr>
<tr><td>144</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad_cfg.dispWarning('Projecting&nbsp;out&nbsp;of&nbsp;range&nbsp;HU&nbsp;values');</td></tr>
<tr><td>145</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HUcube{s}(HUcube{s}(:)&nbsp;&gt;&nbsp;material{end,3})&nbsp;=&nbsp;material{end,3};</td></tr>
<tr><td>146</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>147</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;min(HUcube{s}(:))&nbsp;&lt;&nbsp;material{1,2}</td></tr>
<tr><td>148</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad_cfg.dispWarning('Projecting&nbsp;out&nbsp;of&nbsp;range&nbsp;HU&nbsp;values');</td></tr>
<tr><td>149</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HUcube{s}(HUcube{s}(:)&nbsp;&lt;&nbsp;material{1,2})&nbsp;=&nbsp;material{1,2};</td></tr>
<tr><td>150</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>151</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>152</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;find&nbsp;material&nbsp;index</td></tr>
<tr><td>153</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;cubeMatIx{s}&nbsp;=&nbsp;NaN*ones(dij.doseGrid.dimensions,'int32');</td></tr>
<tr><td>154</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;=&nbsp;size(material,1):-1:1</td></tr>
<tr><td>155</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cubeMatIx{s}(HUcube{s}&nbsp;&lt;=&nbsp;material{i,3})&nbsp;=&nbsp;i;</td></tr>
<tr><td>156</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>157</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>158</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;create&nbsp;an&nbsp;artificial&nbsp;HU&nbsp;lookup&nbsp;table</td></tr>
<tr><td>159</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;hlut&nbsp;=&nbsp;[];</td></tr>
<tr><td>160</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;=&nbsp;1:size(material,1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>161</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hlut&nbsp;=&nbsp;[hlut;material{i,2}&nbsp;material{i,4};material{i,3}-1e-10&nbsp;material{i,5}];&nbsp;%&nbsp;add&nbsp;eps&nbsp;for&nbsp;interpolation</td></tr>
<tr><td>162</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>163</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>164</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;cubeRho{s}&nbsp;=&nbsp;interp1(hlut(:,1),hlut(:,2),HUcube{s});</td></tr>
<tr><td>165</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>166</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>167</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>168</td><td bgcolor="#FF0000">ompMCgeo.material&nbsp;=&nbsp;material;</td></tr>
<tr><td>169</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>170</td><td bgcolor="#FF0000">scale&nbsp;=&nbsp;10;&nbsp;%&nbsp;to&nbsp;convert&nbsp;to&nbsp;cm</td></tr>
<tr><td>171</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>172</td><td bgcolor="#FF0000">ompMCgeo.xBounds&nbsp;=&nbsp;(dij.doseGrid.resolution.y&nbsp;*&nbsp;(0.5&nbsp;+&nbsp;[0:dij.doseGrid.dimensions(1)]))&nbsp;./&nbsp;scale;</td></tr>
<tr><td>173</td><td bgcolor="#FF0000">ompMCgeo.yBounds&nbsp;=&nbsp;(dij.doseGrid.resolution.x&nbsp;*&nbsp;(0.5&nbsp;+&nbsp;[0:dij.doseGrid.dimensions(2)]))&nbsp;./&nbsp;scale;</td></tr>
<tr><td>174</td><td bgcolor="#FF0000">ompMCgeo.zBounds&nbsp;=&nbsp;(dij.doseGrid.resolution.z&nbsp;*&nbsp;(0.5&nbsp;+&nbsp;[0:dij.doseGrid.dimensions(3)]))&nbsp;./&nbsp;scale;</td></tr>
<tr><td>175</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>176</td><td bgcolor="#FFFFFF">%%&nbsp;debug&nbsp;visualization</td></tr>
<tr><td>177</td><td bgcolor="#FF0000">if&nbsp;visBool</td></tr>
<tr><td>178</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>179</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;figure</td></tr>
<tr><td>180</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;hold&nbsp;on</td></tr>
<tr><td>181</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>182</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;axis&nbsp;equal</td></tr>
<tr><td>183</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>184</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;ct&nbsp;box</td></tr>
<tr><td>185</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;ctCorner1&nbsp;=&nbsp;[ompMCgeo.xBounds(1)&nbsp;ompMCgeo.yBounds(1)&nbsp;ompMCgeo.zBounds(1)];</td></tr>
<tr><td>186</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;ctCorner2&nbsp;=&nbsp;[ompMCgeo.xBounds(end)&nbsp;ompMCgeo.yBounds(end)&nbsp;ompMCgeo.zBounds(end)];</td></tr>
<tr><td>187</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner2(1)],[ctCorner1(2)&nbsp;ctCorner1(2)],[ctCorner1(3)&nbsp;ctCorner1(3)],'k'&nbsp;)</td></tr>
<tr><td>188</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner2(1)],[ctCorner2(2)&nbsp;ctCorner2(2)],[ctCorner1(3)&nbsp;ctCorner1(3)],'k'&nbsp;)</td></tr>
<tr><td>189</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner1(1)],[ctCorner1(2)&nbsp;ctCorner2(2)],[ctCorner1(3)&nbsp;ctCorner1(3)],'k'&nbsp;)</td></tr>
<tr><td>190</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner2(1)&nbsp;ctCorner2(1)],[ctCorner1(2)&nbsp;ctCorner2(2)],[ctCorner1(3)&nbsp;ctCorner1(3)],'k'&nbsp;)</td></tr>
<tr><td>191</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner2(1)],[ctCorner1(2)&nbsp;ctCorner1(2)],[ctCorner2(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>192</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner2(1)],[ctCorner2(2)&nbsp;ctCorner2(2)],[ctCorner2(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>193</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner1(1)],[ctCorner1(2)&nbsp;ctCorner2(2)],[ctCorner2(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>194</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner2(1)&nbsp;ctCorner2(1)],[ctCorner1(2)&nbsp;ctCorner2(2)],[ctCorner2(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>195</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner1(1)],[ctCorner1(2)&nbsp;ctCorner1(2)],[ctCorner1(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>196</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner2(1)&nbsp;ctCorner2(1)],[ctCorner1(2)&nbsp;ctCorner1(2)],[ctCorner1(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>197</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner1(1)&nbsp;ctCorner1(1)],[ctCorner2(2)&nbsp;ctCorner2(2)],[ctCorner1(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>198</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3([ctCorner2(1)&nbsp;ctCorner2(1)],[ctCorner2(2)&nbsp;ctCorner2(2)],[ctCorner1(3)&nbsp;ctCorner2(3)],'k'&nbsp;)</td></tr>
<tr><td>199</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>200</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;xlabel('x&nbsp;[cm]')</td></tr>
<tr><td>201</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;ylabel('y&nbsp;[cm]')</td></tr>
<tr><td>202</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;zlabel('z&nbsp;[cm]')</td></tr>
<tr><td>203</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>204</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;rotate3d&nbsp;on</td></tr>
<tr><td>205</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>206</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>207</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>208</td><td bgcolor="#FFFFFF">%%&nbsp;Create&nbsp;beamlet&nbsp;source</td></tr>
<tr><td>209</td><td bgcolor="#FF0000">useCornersSCD&nbsp;=&nbsp;true;&nbsp;%false&nbsp;-&gt;&nbsp;use&nbsp;ISO&nbsp;corners</td></tr>
<tr><td>210</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>211</td><td bgcolor="#FF0000">numOfBixels&nbsp;=&nbsp;[stf(:).numOfRays];</td></tr>
<tr><td>212</td><td bgcolor="#FF0000">beamSource&nbsp;=&nbsp;zeros(dij.numOfBeams,&nbsp;3);</td></tr>
<tr><td>213</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>214</td><td bgcolor="#FF0000">bixelCorner&nbsp;=&nbsp;zeros(dij.totalNumOfBixels,3);</td></tr>
<tr><td>215</td><td bgcolor="#FF0000">bixelSide1&nbsp;=&nbsp;zeros(dij.totalNumOfBixels,3);</td></tr>
<tr><td>216</td><td bgcolor="#FF0000">bixelSide2&nbsp;=&nbsp;zeros(dij.totalNumOfBixels,3);</td></tr>
<tr><td>217</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>218</td><td bgcolor="#FF0000">counter&nbsp;=&nbsp;0;</td></tr>
<tr><td>219</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>220</td><td bgcolor="#FF0000">for&nbsp;i&nbsp;=&nbsp;1:dij.numOfBeams&nbsp;%&nbsp;loop&nbsp;over&nbsp;all&nbsp;beams</td></tr>
<tr><td>221</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>222</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;define&nbsp;beam&nbsp;source&nbsp;in&nbsp;physical&nbsp;coordinate&nbsp;system&nbsp;in&nbsp;cm</td></tr>
<tr><td>223</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;beamSource(i,:)&nbsp;=&nbsp;(stf(i).sourcePoint&nbsp;+&nbsp;stf(i).isoCenter)/10;</td></tr>
<tr><td>224</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>225</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;j&nbsp;=&nbsp;1:stf(i).numOfRays&nbsp;%&nbsp;loop&nbsp;over&nbsp;all&nbsp;rays&nbsp;/&nbsp;for&nbsp;photons&nbsp;we&nbsp;only&nbsp;have&nbsp;one&nbsp;bixel&nbsp;per&nbsp;ray!</td></tr>
<tr><td>226</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>227</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;counter&nbsp;=&nbsp;counter&nbsp;+&nbsp;1;</td></tr>
<tr><td>228</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>229</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dij.beamNum(counter)&nbsp;&nbsp;=&nbsp;i;</td></tr>
<tr><td>230</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dij.rayNum(counter)&nbsp;&nbsp;&nbsp;=&nbsp;j;</td></tr>
<tr><td>231</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dij.bixelNum(counter)&nbsp;=&nbsp;j;</td></tr>
<tr><td>232</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>233</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;useCornersSCD</td></tr>
<tr><td>234</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;beamletCorners&nbsp;=&nbsp;stf(i).ray(j).rayCorners_SCD;</td></tr>
<tr><td>235</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>236</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;beamletCorners&nbsp;=&nbsp;stf(i).ray(j).beamletCornersAtIso;</td></tr>
<tr><td>237</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>238</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>239</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;get&nbsp;bixel&nbsp;corner&nbsp;and&nbsp;delimiting&nbsp;vectors.</td></tr>
<tr><td>240</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;a)&nbsp;change&nbsp;coordinate&nbsp;system&nbsp;(Isocenter&nbsp;cs-&gt;&nbsp;physical&nbsp;cs)&nbsp;and&nbsp;units&nbsp;mm&nbsp;-&gt;&nbsp;cm</td></tr>
<tr><td>241</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currCorner&nbsp;=&nbsp;(beamletCorners(1,:)&nbsp;+&nbsp;stf(i).isoCenter)&nbsp;./&nbsp;scale;</td></tr>
<tr><td>242</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bixelCorner(counter,:)&nbsp;=&nbsp;currCorner;</td></tr>
<tr><td>243</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bixelSide1(counter,:)&nbsp;=&nbsp;(beamletCorners(2,:)&nbsp;+&nbsp;stf(i).isoCenter)&nbsp;./&nbsp;scale&nbsp;-&nbsp;currCorner;</td></tr>
<tr><td>244</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bixelSide2(counter,:)&nbsp;=&nbsp;(beamletCorners(4,:)&nbsp;+&nbsp;stf(i).isoCenter)&nbsp;./&nbsp;scale&nbsp;-&nbsp;currCorner;</td></tr>
<tr><td>245</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>246</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;visBool</td></tr>
<tr><td>247</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;k&nbsp;=&nbsp;1:4</td></tr>
<tr><td>248</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currCornerVis&nbsp;=&nbsp;(beamletCorners(k,:)&nbsp;+&nbsp;stf(i).isoCenter)/10;</td></tr>
<tr><td>249</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;rays&nbsp;connecting&nbsp;source&nbsp;and&nbsp;ray&nbsp;corner</td></tr>
<tr><td>250</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plot3([beamSource(i,1)&nbsp;currCornerVis(1)],[beamSource(i,2)&nbsp;currCornerVis(2)],[beamSource(i,3)&nbsp;currCornerVis(3)],'b')</td></tr>
<tr><td>251</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;connection&nbsp;between&nbsp;corners</td></tr>
<tr><td>252</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lRayCorner&nbsp;=&nbsp;(beamletCorners(mod(k,4)&nbsp;+&nbsp;1,:)&nbsp;+&nbsp;stf(i).isoCenter)/10;</td></tr>
<tr><td>253</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plot3([lRayCorner(1)&nbsp;currCornerVis(1)],[lRayCorner(2)&nbsp;currCornerVis(2)],[lRayCorner(3)&nbsp;currCornerVis(3)],'r')</td></tr>
<tr><td>254</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>255</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>256</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>257</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>258</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>259</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>260</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>261</td><td bgcolor="#FF0000">ompMCsource.nBeams&nbsp;=&nbsp;dij.numOfBeams;</td></tr>
<tr><td>262</td><td bgcolor="#FF0000">ompMCsource.iBeam&nbsp;=&nbsp;dij.beamNum(:);</td></tr>
<tr><td>263</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>264</td><td bgcolor="#FFFFFF">%&nbsp;Switch&nbsp;x&nbsp;and&nbsp;y&nbsp;directions&nbsp;to&nbsp;match&nbsp;ompMC&nbsp;cs.</td></tr>
<tr><td>265</td><td bgcolor="#FF0000">ompMCsource.xSource&nbsp;=&nbsp;beamSource(:,2);</td></tr>
<tr><td>266</td><td bgcolor="#FF0000">ompMCsource.ySource&nbsp;=&nbsp;beamSource(:,1);</td></tr>
<tr><td>267</td><td bgcolor="#FF0000">ompMCsource.zSource&nbsp;=&nbsp;beamSource(:,3);</td></tr>
<tr><td>268</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>269</td><td bgcolor="#FF0000">ompMCsource.nBixels&nbsp;=&nbsp;sum(numOfBixels(:));</td></tr>
<tr><td>270</td><td bgcolor="#FF0000">ompMCsource.xCorner&nbsp;=&nbsp;bixelCorner(:,2);</td></tr>
<tr><td>271</td><td bgcolor="#FF0000">ompMCsource.yCorner&nbsp;=&nbsp;bixelCorner(:,1);</td></tr>
<tr><td>272</td><td bgcolor="#FF0000">ompMCsource.zCorner&nbsp;=&nbsp;bixelCorner(:,3);</td></tr>
<tr><td>273</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>274</td><td bgcolor="#FF0000">ompMCsource.xSide1&nbsp;=&nbsp;bixelSide1(:,2);</td></tr>
<tr><td>275</td><td bgcolor="#FF0000">ompMCsource.ySide1&nbsp;=&nbsp;bixelSide1(:,1);</td></tr>
<tr><td>276</td><td bgcolor="#FF0000">ompMCsource.zSide1&nbsp;=&nbsp;bixelSide1(:,3);</td></tr>
<tr><td>277</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>278</td><td bgcolor="#FF0000">ompMCsource.xSide2&nbsp;=&nbsp;bixelSide2(:,2);</td></tr>
<tr><td>279</td><td bgcolor="#FF0000">ompMCsource.ySide2&nbsp;=&nbsp;bixelSide2(:,1);</td></tr>
<tr><td>280</td><td bgcolor="#FF0000">ompMCsource.zSide2&nbsp;=&nbsp;bixelSide2(:,3);</td></tr>
<tr><td>281</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>282</td><td bgcolor="#FF0000">if&nbsp;visBool</td></tr>
<tr><td>283</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;plot3(ompMCsource.ySource,ompMCsource.xSource,ompMCsource.zSource,'rx')</td></tr>
<tr><td>284</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>285</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>286</td><td bgcolor="#FFFFFF">%%&nbsp;Call&nbsp;the&nbsp;OmpMC&nbsp;interface</td></tr>
<tr><td>287</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>288</td><td bgcolor="#FFFFFF">%ompMC&nbsp;for&nbsp;matRad&nbsp;returns&nbsp;dose/history&nbsp;*&nbsp;nHistories.&nbsp;</td></tr>
<tr><td>289</td><td bgcolor="#FFFFFF">%&nbsp;This&nbsp;factor&nbsp;calibrates&nbsp;to&nbsp;1&nbsp;Gy&nbsp;in&nbsp;a&nbsp;%(5x5)cm^2&nbsp;open&nbsp;field&nbsp;(1&nbsp;bixel)&nbsp;at&nbsp;</td></tr>
<tr><td>290</td><td bgcolor="#FFFFFF">%&nbsp;5cm&nbsp;depth&nbsp;for&nbsp;SSD&nbsp;=&nbsp;900&nbsp;which&nbsp;corresponds&nbsp;to&nbsp;the&nbsp;calibration&nbsp;for&nbsp;the&nbsp;</td></tr>
<tr><td>291</td><td bgcolor="#FFFFFF">%&nbsp;analytical&nbsp;base&nbsp;data.</td></tr>
<tr><td>292</td><td bgcolor="#FF0000">absCalibrationFactor&nbsp;=&nbsp;3.49056&nbsp;*&nbsp;1e12;&nbsp;%Approximate!</td></tr>
<tr><td>293</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>294</td><td bgcolor="#FFFFFF">%Now&nbsp;we&nbsp;have&nbsp;to&nbsp;calibrate&nbsp;to&nbsp;the&nbsp;the&nbsp;beamlet&nbsp;width.</td></tr>
<tr><td>295</td><td bgcolor="#FF0000">absCalibrationFactor&nbsp;=&nbsp;absCalibrationFactor&nbsp;*&nbsp;(pln.propStf.bixelWidth/50)^2;</td></tr>
<tr><td>296</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>297</td><td bgcolor="#FF0000">matRad_cfg.dispInfo('matRad:&nbsp;OmpMC&nbsp;photon&nbsp;dose&nbsp;calculation...&nbsp;\n');</td></tr>
<tr><td>298</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>299</td><td bgcolor="#FF0000">outputVariance&nbsp;=&nbsp;matRad_cfg.propMC.ompMC_defaultOutputVariance;</td></tr>
<tr><td>300</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>301</td><td bgcolor="#FF0000">if&nbsp;isfield(pln,'propMC')&nbsp;&amp;&amp;&nbsp;isfield(pln.propMC,'outputVariance')</td></tr>
<tr><td>302</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;outputVariance&nbsp;=&nbsp;pln.propMC.outputVariance;</td></tr>
<tr><td>303</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>304</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>305</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>306</td><td bgcolor="#FFFFFF">%run&nbsp;over&nbsp;all&nbsp;scenarios</td></tr>
<tr><td>307</td><td bgcolor="#FF0000">for&nbsp;s&nbsp;=&nbsp;1:dij.numOfScenarios</td></tr>
<tr><td>308</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;ompMCgeo.isoCenter&nbsp;=&nbsp;[stf(:).isoCenter];</td></tr>
<tr><td>309</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>310</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%Run&nbsp;the&nbsp;Monte&nbsp;Carlo&nbsp;simulation&nbsp;and&nbsp;catch&nbsp;&nbsp;possible&nbsp;mex-interface</td></tr>
<tr><td>311</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%issues</td></tr>
<tr><td>312</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;try</td></tr>
<tr><td>313</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%If&nbsp;we&nbsp;ask&nbsp;for&nbsp;variance,&nbsp;a&nbsp;field&nbsp;in&nbsp;the&nbsp;dij&nbsp;will&nbsp;be&nbsp;filled</td></tr>
<tr><td>314</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;outputVariance</td></tr>
<tr><td>315</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[dij.physicalDose{s},dij.physicalDose_MCvar{s}]&nbsp;=&nbsp;omc_matrad(cubeRho{s},cubeMatIx{s},ompMCgeo,ompMCsource,ompMCoptions);</td></tr>
<tr><td>316</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</td></tr>
<tr><td>317</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[dij.physicalDose{s}]&nbsp;=&nbsp;omc_matrad(cubeRho{s},cubeMatIx{s},ompMCgeo,ompMCsource,ompMCoptions);</td></tr>
<tr><td>318</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>319</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;catch&nbsp;ME</td></tr>
<tr><td>320</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errorString&nbsp;=&nbsp;[ME.message&nbsp;'\nThis&nbsp;error&nbsp;was&nbsp;thrown&nbsp;by&nbsp;the&nbsp;MEX-interface&nbsp;of&nbsp;ompMC.\nMex&nbsp;interfaces&nbsp;can&nbsp;raise&nbsp;compatability&nbsp;issues&nbsp;which&nbsp;may&nbsp;be&nbsp;resolved&nbsp;by&nbsp;compiling&nbsp;them&nbsp;by&nbsp;hand&nbsp;directly&nbsp;on&nbsp;your&nbsp;particular&nbsp;system.'];</td></tr>
<tr><td>321</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad_cfg.dispError(errorString);</td></tr>
<tr><td>322</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>323</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>324</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%Calibrate&nbsp;the&nbsp;dose&nbsp;with&nbsp;above&nbsp;factor</td></tr>
<tr><td>325</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.physicalDose{s}&nbsp;=&nbsp;dij.physicalDose{s}&nbsp;*&nbsp;absCalibrationFactor;</td></tr>
<tr><td>326</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isfield(dij,'physicalDose_MCvar')</td></tr>
<tr><td>327</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dij.physicalDose_MCvar{s}&nbsp;=&nbsp;dij.physicalDose_MCvar{s}&nbsp;*&nbsp;absCalibrationFactor^2;</td></tr>
<tr><td>328</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>329</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>330</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>331</td><td bgcolor="#FF0000">matRad_cfg.dispInfo('matRad:&nbsp;MC&nbsp;photon&nbsp;dose&nbsp;calculation&nbsp;done!\n');</td></tr>
<tr><td>332</td><td bgcolor="#FF0000">matRad_cfg.dispInfo(evalc('toc'));</td></tr>
<tr><td>333</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>334</td><td bgcolor="#FF0000">try</td></tr>
<tr><td>335</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;wait&nbsp;0.1s&nbsp;for&nbsp;closing&nbsp;all&nbsp;waitbars</td></tr>
<tr><td>336</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;allWaitBarFigures&nbsp;=&nbsp;findall(0,'type','figure','tag','TMWWaitbar');</td></tr>
<tr><td>337</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;delete(allWaitBarFigures);</td></tr>
<tr><td>338</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;pause(0.1);</td></tr>
<tr><td>339</td><td bgcolor="#FF0000">catch</td></tr>
<tr><td>340</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>341</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>342</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>343</td><td bgcolor="#FFFFFF"></td></tr>
</table></p></body></html>