<!DOCTYPE html>
<html><head><title>C:\Users\micha\OneDrive\Dokumente\GitHub\matRad\mox_unitTests\test_Projections.m</title><STYLE TYPE="text/css"><!--TD{font-family: "Courier New", Courier, monospace; font-size: 10pt;}---></STYLE></head><body><p>(Back to <a href="index.html">index</a>)</p><h1>C:\Users\micha\OneDrive\Dokumente\GitHub\matRad\mox_unitTests\test_Projections.m</h1><p style="font-family:'Courier New'"><table>
<tr><th>Line</th><th>Code</th></tr>
<tr><td>1</td><td bgcolor="#FFFFFF">function&nbsp;test_suite=test_Projections</td></tr>
<tr><td>2</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;%&nbsp;assignment&nbsp;of&nbsp;'localfunctions'&nbsp;is&nbsp;necessary&nbsp;in&nbsp;Matlab&nbsp;&gt;=&nbsp;2016</td></tr>
<tr><td>3</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_functions=localfunctions();</td></tr>
<tr><td>4</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch&nbsp;%&nbsp;no&nbsp;problem;&nbsp;early&nbsp;Matlab&nbsp;versions&nbsp;can&nbsp;use&nbsp;initTestSuite&nbsp;fine</td></tr>
<tr><td>5</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>6</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;nVox&nbsp;=&nbsp;3;</td></tr>
<tr><td>7</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;nB&nbsp;=&nbsp;2;</td></tr>
<tr><td>8</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.ax=&nbsp;0.1*ones(nVox,1);</td></tr>
<tr><td>9</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.bx=0.05*ones(nVox,1);</td></tr>
<tr><td>10</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.gamma=dij.ax./(2*dij.bx);</td></tr>
<tr><td>11</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.physicalDose{1}&nbsp;=&nbsp;rand(nVox,nB);</td></tr>
<tr><td>12</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.mAlphaDose{1}&nbsp;=&nbsp;rand(nVox,nB);</td></tr>
<tr><td>13</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.mLetDose{1}&nbsp;=&nbsp;rand(nVox,&nbsp;nB);</td></tr>
<tr><td>14</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.mSqrtBetaDose{1}&nbsp;=&nbsp;rand(nVox,&nbsp;nB);</td></tr>
<tr><td>15</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.ixDose&nbsp;=&nbsp;dij.bx~=0;</td></tr>
<tr><td>16</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.doseGrid.numOfVoxels&nbsp;=&nbsp;nVox;</td></tr>
<tr><td>17</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.fixedCurrent&nbsp;=&nbsp;300;</td></tr>
<tr><td>18</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;dij.RBE&nbsp;=&nbsp;1.1;</td></tr>
<tr><td>19</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;w&nbsp;=&nbsp;ones(nB,1);</td></tr>
<tr><td>20</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%cst{1,3}=&nbsp;'TARGET';</td></tr>
<tr><td>21</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%cst{1,4}{1}&nbsp;=&nbsp;1:nVox;</td></tr>
<tr><td>22</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;test_functions&nbsp;=&nbsp;{};</td></tr>
<tr><td>23</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;MyFolderInfo&nbsp;=&nbsp;dir('..\optimization\projections');&nbsp;%relative&nbsp;path</td></tr>
<tr><td>24</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i=1:length(MyFolderInfo)</td></tr>
<tr><td>25</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(MyFolderInfo(i).name(1)~='.')</td></tr>
<tr><td>26</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not(isequal(MyFolderInfo(i).name,&nbsp;'matRad_BackProjection.m'))</td></tr>
<tr><td>27</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%test_functions{end+1}&nbsp;=&nbsp;eval(['@()&nbsp;testProjection('''&nbsp;MyFolderInfo(i).name,&nbsp;dij,&nbsp;w&nbsp;''')']);&nbsp;%Too&nbsp;show&nbsp;which&nbsp;object&nbsp;failed.&nbsp;Too&nbsp;have&nbsp;object&nbsp;name&nbsp;expliceed&nbsp;in&nbsp;function&nbsp;name.</td></tr>
<tr><td>28</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_functions{end+1}&nbsp;=&nbsp;@()&nbsp;testProjection(MyFolderInfo(i).name,&nbsp;dij,&nbsp;w);</td></tr>
<tr><td>29</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>30</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>31</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>32</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;test_functions&nbsp;=&nbsp;test_functions';</td></tr>
<tr><td>33</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;initTestSuite;</td></tr>
<tr><td>34</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>35</td><td bgcolor="#FFFFFF">function&nbsp;testProjection(fileName,dij,w)</td></tr>
<tr><td>36</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;functionNameHandle&nbsp;=&nbsp;str2func(fileName(1:end-2));</td></tr>
<tr><td>37</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;proj&nbsp;=&nbsp;functionNameHandle();&nbsp;%Constructor</td></tr>
<tr><td>38</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;nVox&nbsp;=&nbsp;dij.doseGrid.numOfVoxels;</td></tr>
<tr><td>39</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;nB&nbsp;=&nbsp;numel(w);</td></tr>
<tr><td>40</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;proj.projectSingleScenarioGradient(dij,{ones(nVox,1)},1,w);&nbsp;%Fails&nbsp;for&nbsp;matRad_VariableRBEProjection..</td></tr>
<tr><td>41</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>42</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;name=class(proj);</td></tr>
<tr><td>43</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;[jacobEst,err]&nbsp;=&nbsp;jacobianest(@(x)&nbsp;proj.computeSingleScenario(dij,1,x'),w');</td></tr>
<tr><td>44</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;gEst&nbsp;=&nbsp;sum(jacobEst)';&nbsp;%Sums&nbsp;each&nbsp;row&nbsp;of&nbsp;the&nbsp;matrix(jacobEst)</td></tr>
<tr><td>45</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;sum(err);&nbsp;%&nbsp;1x2&nbsp;vector</td></tr>
<tr><td>46</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;gDiff&nbsp;=&nbsp;g&nbsp;-&nbsp;gEst;</td></tr>
<tr><td>47</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertEqual(size(g),&nbsp;size(w));</td></tr>
<tr><td>48</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertEqual(size(g),&nbsp;size(gEst));</td></tr>
<tr><td>49</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertEqual(length(g),&nbsp;nB);</td></tr>
<tr><td>50</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%assertEqual(size(jacobEst),&nbsp;[(length(g)+1),&nbsp;length(g)]);&nbsp;%&nbsp;size(jacobEst)&nbsp;==&nbsp;m&nbsp;x&nbsp;n&nbsp;(n==length(g),&nbsp;m==length(g)&nbsp;+1&nbsp;?)</td></tr>
<tr><td>51</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertElementsAlmostEqual(g,&nbsp;gEst,&nbsp;'absolute',&nbsp;max(err));&nbsp;%&nbsp;abs(gEst.*err)&nbsp;==&nbsp;2x1&nbsp;vector&nbsp;*&nbsp;1x2&nbsp;vector...result&nbsp;2x2&nbsp;vector&nbsp;=&gt;&nbsp;Not&nbsp;comparable...</td></tr>
<tr><td>52</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(isreal(g));</td></tr>
<tr><td>53</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertNotEqual(g,&nbsp;NaN);</td></tr>
<tr><td>54</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertNotEqual(g,&nbsp;Inf);</td></tr>
<tr><td>55</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;assertNotEqual(g,&nbsp;-Inf);</td></tr>
<tr><td>56</td><td bgcolor="#FFFFFF"></td></tr>
</table></p></body></html>