<!DOCTYPE html>
<html><head><title>C:\Users\micha\OneDrive\Dokumente\GitHub\matRad\tools\matRad_SFUDoptimization.m</title><STYLE TYPE="text/css"><!--TD{font-family: "Courier New", Courier, monospace; font-size: 10pt;}---></STYLE></head><body><p>(Back to <a href="index.html">index</a>)</p><h1>C:\Users\micha\OneDrive\Dokumente\GitHub\matRad\tools\matRad_SFUDoptimization.m</h1><p style="font-family:'Courier New'"><table>
<tr><th>Line</th><th>Code</th></tr>
<tr><td>1</td><td bgcolor="#FFFFFF">function&nbsp;[resultGUI]&nbsp;=&nbsp;matRad_SFUDoptimization(pln,&nbsp;cst,&nbsp;dij,&nbsp;ct,&nbsp;stf)</td></tr>
<tr><td>2</td><td bgcolor="#FFFFFF">%&nbsp;Calculation&nbsp;of&nbsp;single&nbsp;field&nbsp;uniform&nbsp;dose&nbsp;(SFUD)&nbsp;optimization</td></tr>
<tr><td>3</td><td bgcolor="#FFFFFF">%&nbsp;If&nbsp;provided&nbsp;the&nbsp;dij&nbsp;matrix&nbsp;is&nbsp;used&nbsp;for&nbsp;optimisation,&nbsp;otherwise&nbsp;single</td></tr>
<tr><td>4</td><td bgcolor="#FFFFFF">%&nbsp;beam&nbsp;dijs&nbsp;are&nbsp;calculated&nbsp;(memory&nbsp;saving).</td></tr>
<tr><td>5</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>6</td><td bgcolor="#FFFFFF">%&nbsp;call</td></tr>
<tr><td>7</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;[resultGUI]&nbsp;=&nbsp;matRad_SFUDoptimization(pln,&nbsp;cst,&nbsp;dij)</td></tr>
<tr><td>8</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;or</td></tr>
<tr><td>9</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;[resultGUI]&nbsp;=&nbsp;matRad_SFUDoptimization(pln,&nbsp;cst,&nbsp;[],&nbsp;ct,&nbsp;stf)</td></tr>
<tr><td>10</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>11</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>12</td><td bgcolor="#FFFFFF">%&nbsp;input</td></tr>
<tr><td>13</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;pln:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;pln&nbsp;struct</td></tr>
<tr><td>14</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;cst:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;cst&nbsp;struct</td></tr>
<tr><td>15</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;dij:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;dij&nbsp;struct&nbsp;(optional)</td></tr>
<tr><td>16</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>17</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;ct:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;ct&nbsp;struct&nbsp;(optional,&nbsp;only&nbsp;needed&nbsp;if&nbsp;no&nbsp;dij&nbsp;provided)</td></tr>
<tr><td>18</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;stf:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matRad&nbsp;stf&nbsp;struct&nbsp;(optional,&nbsp;only&nbsp;if&nbsp;needed&nbsp;no&nbsp;dij&nbsp;provided)</td></tr>
<tr><td>19</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>20</td><td bgcolor="#FFFFFF">%&nbsp;output</td></tr>
<tr><td>21</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;resultGUI:&nbsp;&nbsp;struct&nbsp;containing&nbsp;optimized&nbsp;fluence&nbsp;vector,&nbsp;dose,&nbsp;and&nbsp;(for</td></tr>
<tr><td>22</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;biological&nbsp;optimization)&nbsp;RBE-weighted&nbsp;dose&nbsp;etc.</td></tr>
<tr><td>23</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;(info:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;containing&nbsp;information&nbsp;about&nbsp;optimization)</td></tr>
<tr><td>24</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>25</td><td bgcolor="#FFFFFF">%&nbsp;References</td></tr>
<tr><td>26</td><td bgcolor="#FFFFFF">%&nbsp;&nbsp;&nbsp;[1]&nbsp;&nbsp;&nbsp;&nbsp;https://ro-journal.biomedcentral.com/articles/10.1186/s13014-016-0705-8</td></tr>
<tr><td>27</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>28</td><td bgcolor="#FFFFFF">%&nbsp;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</td></tr>
<tr><td>29</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>30</td><td bgcolor="#FFFFFF">%&nbsp;Copyright&nbsp;2015&nbsp;the&nbsp;matRad&nbsp;development&nbsp;team.&nbsp;</td></tr>
<tr><td>31</td><td bgcolor="#FFFFFF">%&nbsp;</td></tr>
<tr><td>32</td><td bgcolor="#FFFFFF">%&nbsp;This&nbsp;file&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;matRad&nbsp;project.&nbsp;It&nbsp;is&nbsp;subject&nbsp;to&nbsp;the&nbsp;license&nbsp;</td></tr>
<tr><td>33</td><td bgcolor="#FFFFFF">%&nbsp;terms&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file&nbsp;found&nbsp;in&nbsp;the&nbsp;top-level&nbsp;directory&nbsp;of&nbsp;this&nbsp;</td></tr>
<tr><td>34</td><td bgcolor="#FFFFFF">%&nbsp;distribution&nbsp;and&nbsp;at&nbsp;https://github.com/e0404/matRad/LICENSES.txt.&nbsp;No&nbsp;part&nbsp;</td></tr>
<tr><td>35</td><td bgcolor="#FFFFFF">%&nbsp;of&nbsp;the&nbsp;matRad&nbsp;project,&nbsp;including&nbsp;this&nbsp;file,&nbsp;may&nbsp;be&nbsp;copied,&nbsp;modified,&nbsp;</td></tr>
<tr><td>36</td><td bgcolor="#FFFFFF">%&nbsp;propagated,&nbsp;or&nbsp;distributed&nbsp;except&nbsp;according&nbsp;to&nbsp;the&nbsp;terms&nbsp;contained&nbsp;in&nbsp;the&nbsp;</td></tr>
<tr><td>37</td><td bgcolor="#FFFFFF">%&nbsp;LICENSE&nbsp;file.</td></tr>
<tr><td>38</td><td bgcolor="#FFFFFF">%</td></tr>
<tr><td>39</td><td bgcolor="#FFFFFF">%&nbsp;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</td></tr>
<tr><td>40</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>41</td><td bgcolor="#FFFFFF">%&nbsp;adjust&nbsp;cst&nbsp;for&nbsp;single&nbsp;beams</td></tr>
<tr><td>42</td><td bgcolor="#FF0000">sb_cst&nbsp;=&nbsp;cst;</td></tr>
<tr><td>43</td><td bgcolor="#FF0000">for&nbsp;i=1:size(sb_cst,1)</td></tr>
<tr><td>44</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;j&nbsp;=&nbsp;1:size(sb_cst{i,6},1)</td></tr>
<tr><td>45</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;biological&nbsp;dose&nbsp;splitting&nbsp;for&nbsp;carbon</td></tr>
<tr><td>46</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;strcmp(pln.bioOptimization,&nbsp;'LEMIV_effect')&nbsp;||&nbsp;...</td></tr>
<tr><td>47</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcmp(pln.bioOptimization,&nbsp;'LEMIV_RBExD')</td></tr>
<tr><td>48</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ab&nbsp;=&nbsp;sb_cst{i,5}.alphaX&nbsp;/&nbsp;sb_cst{i,5}.betaX;</td></tr>
<tr><td>49</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;dose&nbsp;per&nbsp;fraction</td></tr>
<tr><td>50</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fx_dose&nbsp;=&nbsp;sb_cst{i,6}(j).dose&nbsp;/&nbsp;pln.numOfFractions;</td></tr>
<tr><td>51</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;calculate&nbsp;dose&nbsp;per&nbsp;beam&nbsp;per&nbsp;fraction&nbsp;according&nbsp;to&nbsp;[1]</td></tr>
<tr><td>52</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fx_dose&nbsp;=&nbsp;-0.5*ab&nbsp;+sqrt(&nbsp;0.25*ab^2&nbsp;+&nbsp;...</td></tr>
<tr><td>53</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fx_dose/pln.numOfBeams&nbsp;*(fx_dose&nbsp;+&nbsp;ab));</td></tr>
<tr><td>54</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;calculate&nbsp;pseudo&nbsp;total&nbsp;Dose&nbsp;per&nbsp;Beam</td></tr>
<tr><td>55</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_cst{i,6}(j).dose&nbsp;=&nbsp;fx_dose&nbsp;*&nbsp;pln.numOfFractions;</td></tr>
<tr><td>56</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>57</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;physical&nbsp;dose&nbsp;splitting</td></tr>
<tr><td>58</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</td></tr>
<tr><td>59</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_cst{i,6}(j).dose&nbsp;=&nbsp;sb_cst{i,6}(j).dose/pln.numOfBeams;</td></tr>
<tr><td>60</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>61</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>62</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>63</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>64</td><td bgcolor="#FF0000">if&nbsp;~isempty(dij)</td></tr>
<tr><td>65</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;calculate&nbsp;dij&nbsp;with&nbsp;total&nbsp;dij&nbsp;being&nbsp;present</td></tr>
<tr><td>66</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>67</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;initialise&nbsp;total&nbsp;weight&nbsp;vector</td></tr>
<tr><td>68</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;wTot&nbsp;=&nbsp;zeros(dij.totalNumOfBixels,1);</td></tr>
<tr><td>69</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>70</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;=&nbsp;1:pln.numOfBeams</td></tr>
<tr><td>71</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;columns&nbsp;in&nbsp;total&nbsp;dij&nbsp;for&nbsp;single&nbsp;beam</td></tr>
<tr><td>72</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_col&nbsp;=&nbsp;find(dij.beamNum&nbsp;==&nbsp;i);</td></tr>
<tr><td>73</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;construct&nbsp;dij&nbsp;for&nbsp;single&nbsp;beam</td></tr>
<tr><td>74</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.numOfBeams&nbsp;=&nbsp;1;</td></tr>
<tr><td>75</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.doseGrid&nbsp;=&nbsp;dij.doseGrid;</td></tr>
<tr><td>76</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.ctGrid&nbsp;=&nbsp;dij.ctGrid;</td></tr>
<tr><td>77</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.numOfRaysPerBeam&nbsp;=&nbsp;dij.numOfRaysPerBeam(i);</td></tr>
<tr><td>78</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.totalNumOfRays&nbsp;=&nbsp;sb_dij.numOfRaysPerBeam;</td></tr>
<tr><td>79</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.totalNumOfBixels&nbsp;=&nbsp;size(sb_col,&nbsp;1);</td></tr>
<tr><td>80</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.numOfScenarios&nbsp;=&nbsp;dij.numOfScenarios;</td></tr>
<tr><td>81</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.bixelNum&nbsp;=&nbsp;dij.bixelNum(sb_col);</td></tr>
<tr><td>82</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.rayNum&nbsp;=&nbsp;dij.rayNum(sb_col);</td></tr>
<tr><td>83</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.beamNum&nbsp;=&nbsp;dij.beamNum(sb_col);</td></tr>
<tr><td>84</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.physicalDose{1}&nbsp;=&nbsp;dij.physicalDose{1}(:,&nbsp;sb_col);</td></tr>
<tr><td>85</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isfield(dij,&nbsp;'RBE')</td></tr>
<tr><td>86</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.RBE&nbsp;=&nbsp;dij.RBE;</td></tr>
<tr><td>87</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>88</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isfield(dij,&nbsp;'mLETDose')</td></tr>
<tr><td>89</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.mLETDose&nbsp;=&nbsp;dij.mLETDose(:,&nbsp;sb_col);</td></tr>
<tr><td>90</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>91</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isfield(dij,'mAlphaDose')&nbsp;&amp;&amp;&nbsp;isfield(dij,'mSqrtBetaDose')</td></tr>
<tr><td>92</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.mAlphaDose{1}&nbsp;=&nbsp;dij.mAlphaDose{1}(:,&nbsp;sb_col);</td></tr>
<tr><td>93</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij.mSqrtBetaDose{1}&nbsp;=&nbsp;dij.mSqrtBetaDose{1}(:,&nbsp;sb_col);</td></tr>
<tr><td>94</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>95</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>96</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;adjust&nbsp;pln&nbsp;to&nbsp;one&nbsp;beam&nbsp;only</td></tr>
<tr><td>97</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln&nbsp;=&nbsp;pln;</td></tr>
<tr><td>98</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.gantryAngles&nbsp;=&nbsp;pln.gantryAngles(i);</td></tr>
<tr><td>99</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.couchAngles&nbsp;=&nbsp;pln.couchAngles(i);</td></tr>
<tr><td>100</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.numOfBeams&nbsp;=&nbsp;1;</td></tr>
<tr><td>101</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.isoCenter&nbsp;=&nbsp;pln.isoCenter(i,:);</td></tr>
<tr><td>102</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>103</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;optimize&nbsp;single&nbsp;beam</td></tr>
<tr><td>104</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_resultGUI&nbsp;=&nbsp;matRad_fluenceOptimization(sb_dij,sb_cst,sb_pln);&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>105</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>106</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;merge&nbsp;single&nbsp;beam&nbsp;weights&nbsp;into&nbsp;total&nbsp;weight&nbsp;vector</td></tr>
<tr><td>107</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wTot(sb_col)&nbsp;=&nbsp;sb_resultGUI.w;</td></tr>
<tr><td>108</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>109</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>110</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;calculate&nbsp;dose</td></tr>
<tr><td>111</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;resultGUI&nbsp;=&nbsp;matRad_calcCubes(wTot,dij,cst,1);</td></tr>
<tr><td>112</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>113</td><td bgcolor="#FFFFFF">else</td></tr>
<tr><td>114</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;calculate&nbsp;SFUD&nbsp;without&nbsp;total&nbsp;dij</td></tr>
<tr><td>115</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>116</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;initialise&nbsp;total&nbsp;weight&nbsp;vector</td></tr>
<tr><td>117</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;wTot&nbsp;=&nbsp;[];</td></tr>
<tr><td>118</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>119</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;=&nbsp;1:pln.numOfBeams</td></tr>
<tr><td>120</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(['optimizing&nbsp;beam&nbsp;'&nbsp;num2str(i)&nbsp;'...\n']);</td></tr>
<tr><td>121</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;single&nbsp;beam&nbsp;stf</td></tr>
<tr><td>122</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_stf&nbsp;=&nbsp;stf(i);</td></tr>
<tr><td>123</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>124</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;adjust&nbsp;pln&nbsp;to&nbsp;one&nbsp;beam&nbsp;only</td></tr>
<tr><td>125</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln&nbsp;=&nbsp;pln;</td></tr>
<tr><td>126</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.isoCenter&nbsp;=&nbsp;pln.isoCenter(i,:);</td></tr>
<tr><td>127</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.numOfBeams&nbsp;=&nbsp;1;</td></tr>
<tr><td>128</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.gantryAngles&nbsp;=&nbsp;pln.gantryAngles(i);</td></tr>
<tr><td>129</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_pln.couchAngles&nbsp;=&nbsp;pln.couchAngles(i);</td></tr>
<tr><td>130</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>131</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;calculate&nbsp;single&nbsp;beam&nbsp;dij</td></tr>
<tr><td>132</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_dij&nbsp;=&nbsp;matRad_calcParticleDose(ct,sb_stf,sb_pln,sb_cst,false);</td></tr>
<tr><td>133</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>134</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;optimize&nbsp;single&nbsp;beam</td></tr>
<tr><td>135</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb_resultGUI&nbsp;=&nbsp;matRad_fluenceOptimization(sb_dij,sb_cst,sb_pln);&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>136</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>137</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;merge&nbsp;single&nbsp;beam&nbsp;weights&nbsp;into&nbsp;total&nbsp;weight&nbsp;vector</td></tr>
<tr><td>138</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wTot&nbsp;=&nbsp;cat(1,wTot,sb_resultGUI.w);</td></tr>
<tr><td>139</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>140</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;end</td></tr>
<tr><td>141</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>142</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;fprintf('Calculate&nbsp;total&nbsp;dose...\n');</td></tr>
<tr><td>143</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;calculate&nbsp;dose</td></tr>
<tr><td>144</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;resultGUI&nbsp;=&nbsp;matRad_calcDoseDirect(ct,stf,pln,cst,wTot);</td></tr>
<tr><td>145</td><td bgcolor="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;resultGUI.w&nbsp;=&nbsp;wTot;</td></tr>
<tr><td>146</td><td bgcolor="#FFFFFF">end</td></tr>
<tr><td>147</td><td bgcolor="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>148</td><td bgcolor="#FFFFFF">end&nbsp;%eof</td></tr>
<tr><td>149</td><td bgcolor="#FFFFFF"></td></tr>
<tr><td>150</td><td bgcolor="#FFFFFF"></td></tr>
</table></p></body></html>